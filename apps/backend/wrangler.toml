name = "cortex-api"
main = "src/index.ts"
compatibility_date = "2025-01-30"
compatibility_flags = ["nodejs_compat"]
workers_dev = false

routes = [
  { pattern = "askcortex.plutas.in/*", zone_name = "plutas.in" }
]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "cortex-production"
database_id = "9f0902b3-51cf-4cd1-81ca-4cd0c90fed53"

# Vectorize
[[vectorize]]
binding = "VECTORIZE"
index_name = "cortex-embeddings"

# R2 Storage
[[r2_buckets]]
binding = "MEDIA"
bucket_name = "cortex-uploads"

# AI (for embeddings)
[ai]
binding = "AI"

# KV Namespace (for caching)
[[kv_namespaces]]
binding = "CACHE"
id = "d34308c5609c457ebefd2a6f49e06d45"
preview_id = "c63e89884ba54d73b9688c282fe11e51"

# Queue (for async processing)
# NOTE: Re-enabled with proper consumer
[[queues.producers]]
binding = "PROCESSING_QUEUE"
queue = "cortex-processing"

[[queues.consumers]]
queue = "cortex-processing"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "cortex-dlq"

# Scheduled tasks
[triggers]
crons = [
  "*/5 * * * *",    # Every 5min for syncs
  "0 2 * * SUN",    # Sunday 2am for consolidation
  "0 3 * * *",      # 3am UTC - Sleep compute
  "0 9 * * *",      # 9am UTC - Sleep compute
  "0 15 * * *",     # 3pm UTC - Sleep compute
  "0 21 * * *"      # 9pm UTC - Sleep compute
]

# Environment variables
[vars]
ENVIRONMENT = "production"

# Secrets (set with: wrangler secret put SECRET_NAME)
# Required:
# - OPENAI_API_KEY
# - JWT_SECRET
# - COMPOSIO_API_KEY
#
# Optional (for world context features):
# - OPENWEATHER_API_KEY (for weather in briefings)
# - SERPER_API_KEY (for web search and news)
# - YELP_API_KEY (for nearby places/restaurants)
# - GOOGLE_CLIENT_ID (optional, defaults to iOS client ID)
