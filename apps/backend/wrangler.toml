name = "cortex-api"
main = "src/index.ts"
compatibility_date = "2025-01-30"
compatibility_flags = ["nodejs_compat"]
workers_dev = false

routes = [
  { pattern = "askcortex.plutas.in/*", zone_name = "plutas.in" }
]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "cortex-production"
database_id = "9f0902b3-51cf-4cd1-81ca-4cd0c90fed53"

# Vectorize
[[vectorize]]
binding = "VECTORIZE"
index_name = "cortex-embeddings"

# R2 Storage (temporarily disabled - enable R2 subscription to use)
# [[r2_buckets]]
# binding = "MEDIA"
# bucket_name = "cortex-uploads"

# AI (for embeddings)
[ai]
binding = "AI"

# KV Namespace (for caching)
[[kv_namespaces]]
binding = "CACHE"
id = "d34308c5609c457ebefd2a6f49e06d45"
preview_id = "c63e89884ba54d73b9688c282fe11e51"

# Queue (for async processing)
# NOTE: Re-enabled with proper consumer
[[queues.producers]]
binding = "PROCESSING_QUEUE"
queue = "cortex-processing"

[[queues.consumers]]
queue = "cortex-processing"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "cortex-dlq"

# Scheduled tasks (max 5 on free plan)
[triggers]
crons = [
  "* * * * *",      # Every minute: flush batches, process triggers, incremental sync
  "0 */6 * * *",    # Every 6h for trigger reconciliation and cache cleanup
  "0 2 * * SUN",    # Sunday 2am for consolidation
  "0 8 * * *",      # 8am UTC - Morning notifications
  "0 20 * * *"      # 8pm UTC - Evening briefing
]

# Environment variables
[vars]
ENVIRONMENT = "production"
# Base URL for webhooks and callbacks (change per environment)
WEBHOOK_BASE_URL = "https://askcortex.plutas.in"
# Multi-agent orchestration (set to "true" to enable)
# When enabled, chat uses Interaction Agent (personality) + Execution Agent (actions)
# Now optimized: Forces gpt-4o-mini for faster execution on Cloudflare Workers
MULTI_AGENT_ENABLED = "true"
# Proactive system configuration
PROACTIVE_ENABLED = "true"
PROACTIVE_LLM_MODEL = "gpt-4o-mini"
PROACTIVE_CACHE_TTL = "3600"
PROACTIVE_BATCH_CRITICAL = "0"
PROACTIVE_BATCH_HIGH = "30000"
PROACTIVE_BATCH_MEDIUM = "60000"
PROACTIVE_MAX_SYNC_USERS = "10"

# Secrets (set with: wrangler secret put SECRET_NAME)
# Required:
# - OPENAI_API_KEY
# - JWT_SECRET
# - COMPOSIO_API_KEY
#
# Optional (for world context features):
# - OPENWEATHER_API_KEY (for weather in briefings)
# - TAVILY_API_KEY (for web search - AI-optimized search API)
# - YELP_API_KEY (for nearby places/restaurants)
# - GOOGLE_CLIENT_ID (optional, defaults to iOS client ID)
